"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[9741],{3905:function(e,a,t){t.d(a,{Zo:function(){return p},kt:function(){return m}});var n=t(67294);function l(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function s(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function r(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?s(Object(t),!0).forEach((function(a){l(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function c(e,a){if(null==e)return{};var t,n,l=function(e,a){if(null==e)return{};var t,n,l={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||(l[t]=e[t]);return l}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var i=n.createContext({}),d=function(e){var a=n.useContext(i),t=a;return e&&(t="function"==typeof e?e(a):r(r({},a),e)),t},p=function(e){var a=d(e.components);return n.createElement(i.Provider,{value:a},e.children)},o="mdxType",u={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},h=n.forwardRef((function(e,a){var t=e.components,l=e.mdxType,s=e.originalType,i=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),o=d(t),h=l,m=o["".concat(i,".").concat(h)]||o[h]||u[h]||s;return t?n.createElement(m,r(r({ref:a},p),{},{components:t})):n.createElement(m,r({ref:a},p))}));function m(e,a){var t=arguments,l=a&&a.mdxType;if("string"==typeof e||l){var s=t.length,r=new Array(s);r[0]=h;var c={};for(var i in a)hasOwnProperty.call(a,i)&&(c[i]=a[i]);c.originalType=e,c[o]="string"==typeof e?e:l,r[1]=c;for(var d=2;d<s;d++)r[d]=t[d];return n.createElement.apply(null,r)}return n.createElement.apply(null,t)}h.displayName="MDXCreateElement"},3350:function(e,a,t){t.r(a),t.d(a,{assets:function(){return p},contentTitle:function(){return i},default:function(){return m},frontMatter:function(){return c},metadata:function(){return d},toc:function(){return o}});var n=t(87462),l=t(63366),s=(t(67294),t(3905)),r=["components"],c={title:"Headscale \u7684\u90e8\u7f72\u65b9\u6cd5\u548c\u4f7f\u7528\u6559\u7a0b",tags:["headscale","tailscale","\u5185\u7f51\u7a7f\u900f"]},i=void 0,d={unversionedId:"misc/tailscale/headscale",id:"misc/tailscale/headscale",title:"Headscale \u7684\u90e8\u7f72\u65b9\u6cd5\u548c\u4f7f\u7528\u6559\u7a0b",description:"\u76ee\u7684\u6253\u901a\u6240\u6709\u73af\u5883, \u7ec4\u5efa\u5927\u5c40\u57df\u7f51",source:"@site/docs/misc/tailscale/headscale.md",sourceDirName:"misc/tailscale",slug:"/misc/tailscale/headscale",permalink:"/docs/misc/tailscale/headscale",draft:!1,tags:[{label:"headscale",permalink:"/docs/tags/headscale"},{label:"tailscale",permalink:"/docs/tags/tailscale"},{label:"\u5185\u7f51\u7a7f\u900f",permalink:"/docs/tags/\u5185\u7f51\u7a7f\u900f"}],version:"current",lastUpdatedBy:"ysicing",lastUpdatedAt:1678288735,formattedLastUpdatedAt:"2023\u5e743\u67088\u65e5",frontMatter:{title:"Headscale \u7684\u90e8\u7f72\u65b9\u6cd5\u548c\u4f7f\u7528\u6559\u7a0b",tags:["headscale","tailscale","\u5185\u7f51\u7a7f\u900f"]},sidebar:"tutorialSidebar",previous:{title:"\u7fa4\u6656\u4e0a\u57fa\u4e8eHeadscale\u5185\u7f51\u7a7f\u900f",permalink:"/docs/misc/tailscale/headscale-dsm7"},next:{title:"\u8f7b\u91cf\u4e91debian\u6302\u8f7d\u6570\u636e\u76d8",permalink:"/docs/os/debian/disk-mount"}},p={},o=[{value:"WireGuard\u662f\u4ec0\u4e48",id:"wireguard\u662f\u4ec0\u4e48",level:2},{value:"Tailscale\u662f\u4ec0\u4e48",id:"tailscale\u662f\u4ec0\u4e48",level:2},{value:"Headscale\u662f\u4ec0\u4e48",id:"headscale\u662f\u4ec0\u4e48",level:2},{value:"Headscale \u90e8\u7f72",id:"headscale-\u90e8\u7f72",level:2},{value:"\u4e0b\u8f7d\u4e8c\u8fdb\u5236",id:"\u4e0b\u8f7d\u4e8c\u8fdb\u5236",level:3},{value:"\u51c6\u5907\u76f8\u5173\u76ee\u5f55\u6216\u8005\u6587\u4ef6",id:"\u51c6\u5907\u76f8\u5173\u76ee\u5f55\u6216\u8005\u6587\u4ef6",level:3},{value:"\u7f16\u8f91\u914d\u7f6e",id:"\u7f16\u8f91\u914d\u7f6e",level:3},{value:"\u542f\u52a8HeadScale",id:"\u542f\u52a8headscale",level:3},{value:"\u547d\u540d\u7a7a\u95f4\u7ba1\u7406",id:"\u547d\u540d\u7a7a\u95f4\u7ba1\u7406",level:3},{value:"\u591a\u7aef\u63a5\u5165",id:"\u591a\u7aef\u63a5\u5165",level:3},{value:"macOS\u5b89\u88c5",id:"macos\u5b89\u88c5",level:4},{value:"\u7fa4\u6656DS218+\u5b89\u88c5",id:"\u7fa4\u6656ds218\u5b89\u88c5",level:4},{value:"\u5bb9\u5668\u63a5\u5165",id:"\u5bb9\u5668\u63a5\u5165",level:4},{value:"\u5c40\u57df\u7f51\u6253\u901a",id:"\u5c40\u57df\u7f51\u6253\u901a",level:3}],u={toc:o},h="wrapper";function m(e){var a=e.components,t=(0,l.Z)(e,r);return(0,s.kt)(h,(0,n.Z)({},u,t,{components:a,mdxType:"MDXLayout"}),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u76ee\u7684\u6253\u901a\u6240\u6709\u73af\u5883, \u7ec4\u5efa\u5927\u5c40\u57df\u7f51")),(0,s.kt)("h2",{id:"wireguard\u662f\u4ec0\u4e48"},"WireGuard\u662f\u4ec0\u4e48"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("inlineCode",{parentName:"p"},"WireGuard"),"\u662f\u4e00\u4e2a\u6613\u4e8e\u914d\u7f6e\u3001\u5feb\u901f\u4e14\u5b89\u5168\u7684\u5f00\u6e90VPN\u6280\u672f, \u4e3b\u8981\u4f18\u70b9\u914d\u7f6e\u548c\u90e8\u7f72 WireGuard \u5c31\u50cf\u914d\u7f6e\u548c\u4f7f\u7528SSH\u4e00\u6837\u5bb9\u6613\u3002")),(0,s.kt)("p",null,"\u4e3b\u8981\u7528\u9014\u53d6\u4ee3",(0,s.kt)("inlineCode",{parentName:"p"},"OpenVPN"),"\u7b49\u4f20\u7edf\u7ec4\u7f51\u5de5\u5177\u3002"),(0,s.kt)("h2",{id:"tailscale\u662f\u4ec0\u4e48"},"Tailscale\u662f\u4ec0\u4e48"),(0,s.kt)("p",null,"Tailscale \u662f\u4e00\u6b3e\u57fa\u4e8e WireGuard \u7684\u865a\u62df\u7ec4\u7f51\u5de5\u5177, \u7b80\u5316\u4e86WireGuard\u90e8\u7f72\u6d41\u7a0b\uff0c\u5f00\u7bb1\u5373\u7528\u3002\nTailscale \u662f\u4e00\u6b3e\u5546\u4e1a\u4ea7\u54c1\uff0c\u4f46\u4e2a\u4eba\u7528\u6237\u662f\u53ef\u4ee5\u767d\u5ad6\u7684, \u57fa\u672c\u53ef\u4ee5\u6ee1\u8db3\u4f7f\u7528\u9700\u6c42\u3002"),(0,s.kt)("h2",{id:"headscale\u662f\u4ec0\u4e48"},"Headscale\u662f\u4ec0\u4e48"),(0,s.kt)("p",null,"\u5b9e\u73b0\u4e86 Tailscale \u63a7\u5236\u670d\u52a1\u5668\u7684\u6240\u6709\u4e3b\u8981\u529f\u80fd, ",(0,s.kt)("strong",{parentName:"p"},"\u81ea\u4e3b\u53ef\u63a7")),(0,s.kt)("h2",{id:"headscale-\u90e8\u7f72"},"Headscale \u90e8\u7f72"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u90e8\u7f72\u6bd4\u8f83\u7b80\u5355, \u8fd9\u91cc\u7b80\u5355\u8bb0\u5f55\u4e00\u4e0b")),(0,s.kt)("h3",{id:"\u4e0b\u8f7d\u4e8c\u8fdb\u5236"},"\u4e0b\u8f7d\u4e8c\u8fdb\u5236"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://ghproxy.com/https://github.com/juanfont/headscale/releases/download/v0.17.0-alpha1/headscale_0.17.0-alpha1_linux_amd64\nchmod +x headscale_0.17.0-alpha1_linux_amd64\nmv headscale_0.17.0-alpha1_linux_amd64 /usr/local/bin/headscale\n")),(0,s.kt)("h3",{id:"\u51c6\u5907\u76f8\u5173\u76ee\u5f55\u6216\u8005\u6587\u4ef6"},"\u51c6\u5907\u76f8\u5173\u76ee\u5f55\u6216\u8005\u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u521b\u5efa\u914d\u7f6e\u76ee\u5f55\nmkdir -p /etc/headscale\n# \u521b\u5efa\u76ee\u5f55\u7528\u6765\u5b58\u50a8\u6570\u636e\u4e0e\u8bc1\u4e66\nmkdir -p /var/lib/headscale\n# \u521b\u5efa\u7a7a\u7684 SQLite \u6570\u636e\u5e93\u6587\u4ef6\ntouch /var/lib/headscale/db.sqlite\n# \u4e0b\u8f7d Headscale \u914d\u7f6e\u6587\u4ef6\nwget https://github.com/juanfont/headscale/raw/main/config-example.yaml -O /etc/headscale/config.yaml\n# \u521b\u5efa\u7528\u6237\nuseradd headscale -d /home/headscale -m\nchown -R headscale:headscale /var/lib/headscale\n")),(0,s.kt)("h3",{id:"\u7f16\u8f91\u914d\u7f6e"},"\u7f16\u8f91\u914d\u7f6e"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'---\nserver_url: https://<headscale.knj01.ysicing.net>:443\nlisten_addr: 0.0.0.0:443\nmetrics_listen_addr: 127.0.0.1:9090\ngrpc_listen_addr: 0.0.0.0:50443\ngrpc_allow_insecure: false\nprivate_key_path: /var/lib/headscale/private.key\nnoise:\n  private_key_path: /var/lib/headscale/noise_private.key\nip_prefixes:\n  - 10.77.0.0/24\nderp:\n  server:\n    enabled: false\n    region_id: 999\n    region_code: "headscale"\n    region_name: "Headscale Embedded DERP"\n    stun_listen_addr: "0.0.0.0:3478"\n  urls:\n    - https://controlplane.tailscale.com/derpmap/default\n  paths: []\n  auto_update_enabled: true\n  update_frequency: 2h\ndisable_check_updates: false\nephemeral_node_inactivity_timeout: 30m\nnode_update_check_interval: 10s\ndb_type: sqlite3\ndb_path: /var/lib/headscale/db.sqlite\nacme_url: https://acme-v02.api.letsencrypt.org/directory\nacme_email: "root@ysicing.net"\ntls_letsencrypt_hostname: "<\u81ea\u5df1\u7684\u57df\u540d>"\ntls_client_auth_mode: relaxed\ntls_letsencrypt_cache_dir: /var/lib/headscale/cache\ntls_letsencrypt_challenge_type: HTTP-01\ntls_letsencrypt_listen: ":http"\ntls_cert_path: ""\ntls_key_path: ""\nlog_level: info\nacl_policy_path: ""\ndns_config:\n  nameservers:\n    - 1.1.1.1\n  domains: []\n  magic_dns: false\n  base_domain: example.com\nunix_socket: /var/run/headscale/headscale.sock\nunix_socket_permission: "0770"\nlogtail:\n  enabled: false\nrandomize_client_port: false\n')),(0,s.kt)("h3",{id:"\u542f\u52a8headscale"},"\u542f\u52a8HeadScale"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# cat /etc/systemd/system/headscale.service\n[Unit]\nDescription=headscale controller\nAfter=syslog.target\nAfter=network.target\n\n[Service]\nType=simple\nUser=headscale\nGroup=headscale\nExecStart=/usr/local/bin/headscale serve\nRestart=always\nRestartSec=5\n\n# Optional security enhancements\nNoNewPrivileges=yes\nPrivateTmp=yes\nProtectSystem=strict\nProtectHome=yes\nReadWritePaths=/var/lib/headscale /var/run/headscale\nAmbientCapabilities=CAP_NET_BIND_SERVICE\nRuntimeDirectory=headscale\n\n[Install]\nWantedBy=multi-user.target\n")),(0,s.kt)("p",null,"\u5f00\u542f\u542f\u52a8"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable --now headscale\nsystemctl status headscale\n")),(0,s.kt)("p",null,"\u67e5\u770b\u7aef\u53e3\u60c5\u51b5"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'ss -tulnp|grep headscale\ntcp   LISTEN 0      32768      127.0.0.1:9090       0.0.0.0:*    users:(("headscale",pid=4426,fd=15))\ntcp   LISTEN 0      32768              *:50443            *:*    users:(("headscale",pid=4426,fd=10))\ntcp   LISTEN 0      32768              *:80               *:*    users:(("headscale",pid=4426,fd=13))\ntcp   LISTEN 0      32768              *:443              *:*    users:(("headscale",pid=4426,fd=14))\n')),(0,s.kt)("p",null,"\u7a0d\u7b49\u7247\u523b\u8bbf\u95ee\u8bbe\u7f6e\u7684\u57df\u540d\u663e\u793ahttps\u5373\u53ef"),(0,s.kt)("h3",{id:"\u547d\u540d\u7a7a\u95f4\u7ba1\u7406"},"\u547d\u540d\u7a7a\u95f4\u7ba1\u7406"),(0,s.kt)("p",null,"Tailscale \u4e2d\u6709\u4e00\u4e2a\u6982\u5ff5\u53eb tailnet\uff0c\u4f60\u53ef\u4ee5\u7406\u89e3\u6210\u79df\u6237\uff0c\u79df\u6237\u4e0e\u79df\u6237\u4e4b\u95f4\u662f\u76f8\u4e92\u9694\u79bb\u7684\uff0c\u5177\u4f53\u770b\u53c2\u8003 Tailscale \u7684\u5b98\u65b9\u6587\u6863\uff1a ",(0,s.kt)("a",{parentName:"p",href:"https://tailscale.com/kb/1136/tailnet/"},"What is a tailnet"),"\u3002Headscale \u4e5f\u6709\u7c7b\u4f3c\u7684\u5b9e\u73b0\u53eb namespace\uff0c\u5373\u547d\u540d\u7a7a\u95f4\u3002\u6211\u4eec\u9700\u8981\u5148\u521b\u5efa\u4e00\u4e2a namespace\uff0c\u4ee5\u4fbf\u540e\u7eed\u5ba2\u6237\u7aef\u63a5\u5165"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nheadscale namespaces create default\n# \u67e5\u770b\u547d\u540d\u7a7a\u95f4\nheadscale namespaces list\nID | Name    | Created\n1  | default | 2022-09-02 13:00:37\n")),(0,s.kt)("h3",{id:"\u591a\u7aef\u63a5\u5165"},"\u591a\u7aef\u63a5\u5165"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"tailscale up --login-server=https://<\u81ea\u5b9a\u4e49\u57df\u540d> --accept-routes=true --accept-dns=false\n")),(0,s.kt)("p",null,"\u6267\u884c\u5b8c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\uff0c\u4f1a\u51fa\u73b0\u4e0b\u9762\u7684\u4fe1\u606f"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"To authenticate, visit:\n\nhttps://xxxxxx:443/register/de703e5f2e326cfa4b95c866ce13397433b81fcc22de6cf4e39770095facf921\n\n")),(0,s.kt)("p",null,"\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u8be5\u94fe\u63a5, \u5c06\u9875\u9762\u7684\u547d\u4ee4\u590d\u5236\u7c98\u8d34\u5230 headscale \u6240\u5728\u673a\u5668\u7684\u7ec8\u7aef\u4e2d\uff0c\u5e76\u5c06 NAMESPACE \u66ff\u6362\u4e3a\u524d\u9762\u6240\u521b\u5efa\u7684 namespace, \u7c7b\u4f3c\u5982\u4e0b:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"}," headscale -n default nodes register --key de703e5f2e326cfa4b95c866ce13397433b81fcc22de6cf4e39770095facf921\n")),(0,s.kt)("p",null,"\u5982\u679c\u8282\u70b9\u6bd4\u8f83\u591a:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\nheadscale -n default nodes register --key $1\nheadscale node list\n")),(0,s.kt)("h4",{id:"macos\u5b89\u88c5"},"macOS\u5b89\u88c5"),(0,s.kt)("p",null,"\u53ef\u4ee5\u53c2\u8003",(0,s.kt)("a",{parentName:"p",href:"https://icloudnative.io/posts/how-to-set-up-or-migrate-headscale/#macos"},"macOS\u914d\u7f6e")),(0,s.kt)("h4",{id:"\u7fa4\u6656ds218\u5b89\u88c5"},"\u7fa4\u6656DS218+\u5b89\u88c5"),(0,s.kt)("p",null,"\u4e0b\u8f7d\u5ba2\u6237\u7aef\u5e76\u5b89\u88c5",(0,s.kt)("a",{parentName:"p",href:"https://pkgs.tailscale.com/stable/tailscale-x86_64-1.30.0-300007-dsm7.spk"},"tailscale-x86_64-dsm7")),(0,s.kt)("p",null,"ssh\u767b\u5f55\u7fa4\u6656"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"sudo tailscale down\nsudo tailscale up --login-server=https://\u81ea\u5b9a\u4e49\u57df\u540d --accept-dns=false\n# \u540e\u7eed\u540c\n")),(0,s.kt)("h4",{id:"\u5bb9\u5668\u63a5\u5165"},"\u5bb9\u5668\u63a5\u5165"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u670d\u52a1\u7aef\u751f\u6210\u53ef\u590d\u7528 preauthkey \u7684 token\uff0c\u6709\u6548\u671f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a 72 \u5c0f\u65f6\nheadscale preauthkeys create -e 72h --reusable --namespace default\n# \u67e5\u770b\u5df2\u7ecf\u751f\u6210\u7684 key\nheadscale -n default preauthkeys list\n")),(0,s.kt)("admonition",{type:"danger"},(0,s.kt)("del",null,"\u6253\u901ak8s, cilium\u5bb9\u5668\u7f51\u7edc\u5c31\u6302\u4e86\u3002 \u6682\u65f6\u4e0d\u6253\u901a")),(0,s.kt)("admonition",{type:"info"},(0,s.kt)("p",{parentName:"admonition"},"\u8c03\u6574\u6210\u9ed8\u8ba4\u7f51\u7edc\u5c31\u597d\u4e86")),(0,s.kt)("h3",{id:"\u5c40\u57df\u7f51\u6253\u901a"},"\u5c40\u57df\u7f51\u6253\u901a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'# \u6dfb\u52a0route\ntailscale up --login-server=https://<\u81ea\u5b9a\u4e49\u57df\u540d> --accept-routes=true --accept-dns=false --advertise-routes=10.80.0.0/16,10.90.0.0/16\n# \u5f00\u542f\u8def\u7531\nheadscale routes enable -i 6 -r "10.90.0.0/16,10.80.0.0/16"\n# \u8def\u7531\u5217\u8868\nheadscale routes list -i 6\nRoute        | Enabled\n10.80.0.0/16 | true\n10.90.0.0/16 | true\n')),(0,s.kt)("p",null,"\u6d4b\u8bd5"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u67e5\u770b\u8def\u7531\nip route show table 52 | grep 10.80.0.0/16\n10.80.0.0/16 dev tailscale0\n# \u6d4b\u8bd5\u8bbf\u95eek3s coredns\n\n")))}m.isMDXComponent=!0}}]);