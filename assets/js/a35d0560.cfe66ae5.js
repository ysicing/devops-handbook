"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[8408],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return d}});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var i=r.createContext({}),c=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(i.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,s=e.originalType,i=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=c(t),d=a,k=m["".concat(i,".").concat(d)]||m[d]||u[d]||s;return t?r.createElement(k,l(l({ref:n},p),{},{components:t})):r.createElement(k,l({ref:n},p))}));function d(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var s=t.length,l=new Array(s);l[0]=m;var o={};for(var i in n)hasOwnProperty.call(n,i)&&(o[i]=n[i]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var c=2;c<s;c++)l[c]=t[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},25863:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return i},default:function(){return d},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return u}});var r=t(83117),a=t(80102),s=(t(67294),t(3905)),l=["components"],o={title:"\u57fa\u4e8eALIDNS\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66",date:new Date("2020-10-26T03:02:44.000Z"),description:"k8s \u4e0a\u5229\u7528 cert-manager \u81ea\u52a8\u7b7e\u53d1 TLS \u8bc1\u4e66",tags:["kubernetes","cert-manager","aliyun"]},i=void 0,c={permalink:"/posts/cert-manager-install",source:"@site/blog/posts/cert-manager-install.md",title:"\u57fa\u4e8eALIDNS\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66",description:"k8s \u4e0a\u5229\u7528 cert-manager \u81ea\u52a8\u7b7e\u53d1 TLS \u8bc1\u4e66",date:"2020-10-26T03:02:44.000Z",formattedDate:"2020\u5e7410\u670826\u65e5",tags:[{label:"kubernetes",permalink:"/tags/kubernetes"},{label:"cert-manager",permalink:"/tags/cert-manager"},{label:"aliyun",permalink:"/tags/aliyun"}],readingTime:3.2533333333333334,hasTruncateMarker:!0,authors:[],frontMatter:{title:"\u57fa\u4e8eALIDNS\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66",date:"2020-10-26T03:02:44.000Z",description:"k8s \u4e0a\u5229\u7528 cert-manager \u81ea\u52a8\u7b7e\u53d1 TLS \u8bc1\u4e66",tags:["kubernetes","cert-manager","aliyun"]},prevItem:{title:"Debian 11\u5b89\u88c5k3s",permalink:"/posts/k3s-install-bullseye"},nextItem:{title:"\u4f7f\u7528Artifactory\u90e8\u7f72\u79c1\u6709\u5316\u8f6f\u4ef6\u6e90",permalink:"/posts/artifactory-setup-mirrors"}},p={authorsImageUrls:[]},u=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u5de5\u4f5c\u539f\u7406",id:"\u5de5\u4f5c\u539f\u7406",level:2},{value:"\u8bc1\u4e66\u7b7e\u53d1\u539f\u7406",id:"\u8bc1\u4e66\u7b7e\u53d1\u539f\u7406",level:3},{value:"\u64cd\u4f5c\u6b65\u9aa4",id:"\u64cd\u4f5c\u6b65\u9aa4",level:2},{value:"\u5b89\u88c5 cert-manager",id:"\u5b89\u88c5-cert-manager",level:3},{value:"DNS-01\u6821\u9a8c",id:"dns-01\u6821\u9a8c",level:3},{value:"\u90e8\u7f72alidns-webhook",id:"\u90e8\u7f72alidns-webhook",level:4},{value:"\u521b\u5efaClusterIssuer",id:"\u521b\u5efaclusterissuer",level:3},{value:"\u521b\u5efa Certificate",id:"\u521b\u5efa-certificate",level:3},{value:"\u83b7\u53d6\u548c\u4f7f\u7528\u8bc1\u4e66",id:"\u83b7\u53d6\u548c\u4f7f\u7528\u8bc1\u4e66",level:3},{value:"\u4f7f\u7528\u8bc1\u4e66",id:"\u4f7f\u7528\u8bc1\u4e66",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],m={toc:u};function d(e){var n=e.components,t=(0,a.Z)(e,l);return(0,s.kt)("wrapper",(0,r.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"\u6982\u8ff0"},"\u6982\u8ff0"),(0,s.kt)("p",null,"\u968f\u7740\u4e92\u8054\u7f51\u53d1\u5c55\uff0chttps\u8d8a\u6765\u8d8a\u666e\u53ca\uff0c\u662f\u4e2a\u7f51\u7ad9\u90fd\u8981\u4e0a\u4e2ahttps\uff0c\u5426\u5219\u5c31\u662f\u975e\u4e3b\u6d41\u54c8\u54c8\u54c8\u3002\u4e4b\u524d\u4e5f\u4ecb\u7ecd\u8fc7",(0,s.kt)("strong",{parentName:"p"},"caddy"),"\uff0c\u81ea\u52a8\u7b7e\u53d1https\u8bc1\u4e66\uff0c\u8fd9\u662f\u4e00\u4e2a\u4f20\u7edf\u7684\u65b9\u5f0f\u3002\u90a3\u4e48\u670d\u52a1\u4e0a\u5230k8s\u4e0a\uff0c\u5982\u4f55\u5b9e\u73b0\u6c38\u4e45\u514d\u8d39\u8bc1\u4e66\u4e86\u3002",(0,s.kt)("strong",{parentName:"p"},"cert-manager")," \u662f Kubernetes \u4e0a\u6bd4\u8f83\u725b\u903c\u7684\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4ece\u5404\u79cd\u6765\u6e90\u9881\u53d1\u8bc1\u4e66\uff0c\u800c\u4e14\u786e\u4fdd\u8bc1\u4e66\u6709\u6548\u4e14\u6700\u65b0\uff0c\u5e76\u5c1d\u8bd5\u5728\u5230\u671f\u524d\u7684\u914d\u7f6e\u65f6\u95f4\u7eed\u8ba2\u8bc1\u4e66\u3002"),(0,s.kt)("h2",{id:"\u5de5\u4f5c\u539f\u7406"},"\u5de5\u4f5c\u539f\u7406"),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://gitee.com/godu/blogimage/raw/master/blog/20201026/high-level-overview.svg",alt:"005"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"cert-manager"),"\u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa4\u540e\uff0c\u6839\u636e\u5b9e\u9645\u6307\u5b9a\u7684CRD\u8d44\u6e90\u6765\u7b7e\u53d1\u8bc1\u4e66\u5e76\u81ea\u52a8\u7eed\u671f\u3002"),(0,s.kt)("p",null,"\u90e8\u5206\u540d\u8bcd\u89e3\u91ca"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"Issuer"),"/",(0,s.kt)("strong",{parentName:"p"},"ClusterIssuer"),": \u5b9a\u4e49\u8bc1\u4e66\u7b7e\u53d1\u7684\u59ff\u52bf\u3002\u4e24\u8005\u552f\u4e00\u533a\u522b\u5c31\u662f",(0,s.kt)("strong",{parentName:"p"},"Issuer"),"\u53ea\u80fd\u7528\u6765\u7b7e\u53d1\u5355\u4e00ns\u4e0b\u7684\u8bc1\u4e66\uff0c",(0,s.kt)("strong",{parentName:"p"},"ClusterIssuer"),"\u53ef\u4ee5\u7b7e\u53d1\u96c6\u7fa4\u7ea7\u522b\u7684\u8bc1\u4e66\u3002")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"Certificate"),": \u5177\u4f53\u7b7e\u53d1\u57df\u540d\u4ee5\u53ca\u901a\u8fc7\u54ea\u79cd\u59ff\u52bf(\u5373",(0,s.kt)("b",null,"\u6307\u5b9aIssuer/ClusterIssuer"),")\u3002"))),(0,s.kt)("h3",{id:"\u8bc1\u4e66\u7b7e\u53d1\u539f\u7406"},"\u8bc1\u4e66\u7b7e\u53d1\u539f\u7406"),(0,s.kt)("p",null,"\u7531\u4e8e",(0,s.kt)("strong",{parentName:"p"},"cert-manager"),"\u662f\u57fa\u4e8e",(0,s.kt)("strong",{parentName:"p"},"ACME"),"\u534f\u8bae\u4e0e",(0,s.kt)("strong",{parentName:"p"},"Let's Encrypt"),"\u6765\u7b7e\u53d1\u514d\u8d39\u8bc1\u4e66\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8be6\u7ec6\u8bf4\u660e\u8fd9\u4e2a\u4e86, \u5176\u4e3b\u6d41\u6821\u9a8c\u65b9\u5f0f\u662f",(0,s.kt)("strong",{parentName:"p"},"HTTP-01")," \u548c ",(0,s.kt)("strong",{parentName:"p"},"DNS-01"),"\u3002\u7531\u4e8e\u6211\u4eec\u9700\u8981\u5728\u5185\u7f51\u7b7e\u53d1\u8bc1\u4e66\uff0cHTTP-01\u6821\u9a8c\u65b9\u5f0f\u5c31\u4e0d\u592a\u9002\u7528\u4e86\u3002"),(0,s.kt)("h2",{id:"\u64cd\u4f5c\u6b65\u9aa4"},"\u64cd\u4f5c\u6b65\u9aa4"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u63a8\u8350\u4f7f\u7528",(0,s.kt)("strong",{parentName:"p"},"helmv3"),"\u5b89\u88c5")),(0,s.kt)("h3",{id:"\u5b89\u88c5-cert-manager"},"\u5b89\u88c5 cert-manager"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"# \u521b\u5efa\u547d\u540d\u7a7a\u95f4\nkubectl create namespace cert-manager\n# \u6dfb\u52a0helm\u4ed3\u5e93\u6216\u8005\u66f4\u65b0\nhelm repo add jetstack https://charts.jetstack.io\nhelm repo update\nhelminit\n# \u4e00\u952e\u5b89\u88c5\nhelm upgrade -i cert-manager -n cert-manager -f https://gitee.com/godu/helminit/raw/master/cert-manager.1.0.3.yaml --version v1.0.3 jetstack/cert-manager\n# \u67e5\u770b\u5b89\u88c5\u60c5\u51b5\nkubectl get pods -n cert-manager\nNAME                                       READY   STATUS    RESTARTS   AGE\ncert-manager-6564dc56bf-qgxlr              1/1     Running   0          97s\ncert-manager-cainjector-7b98cf8646-t6cqd   1/1     Running   0          97s\ncert-manager-webhook-5f8bb4f46c-44hzt      1/1     Running   0          97s\n")),(0,s.kt)("h3",{id:"dns-01\u6821\u9a8c"},"DNS-01\u6821\u9a8c"),(0,s.kt)("p",null,"\u56e0\u4e3adns\u6258\u7ba1\u5728\u963f\u91cc\u4e91\uff0c\u4e14cert-manager\u4e0d\u652f\u6301alidns\uff0c\u53ea\u80fd\u901a\u8fc7webhook\u65b9\u5f0f\u90e8\u7f72\uff0c\u6765\u6269\u5c55DNS\u63d0\u4f9b\u5546\u3002"),(0,s.kt)("p",null,"\u8fd9\u91cc\u4ee5\u963f\u91ccdns + alidns-webhook\u65b9\u5f0f\u4e3a\u4f8b\u3002"),(0,s.kt)("h4",{id:"\u90e8\u7f72alidns-webhook"},"\u90e8\u7f72alidns-webhook"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u5b89\u88c5alidns-webhook")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u9ed8\u8ba4\u955c\u50cf\u4f7f\u7528\u963f\u91cc\u4e91k7scn\nkubectl apply -f https://gitee.com/godu/helminit/raw/master/cert-manager/alidns-cm-webhook.yaml\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u521b\u5efaalidns api secret")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Secret\nmetadata:\n  name: alidns-secret\n  namespace: cert-manager\ndata:\n  access-key: YOUR_ACCESS_KEY # base64\n  secret-key: YOUR_SECRET_KEY\n")),(0,s.kt)("p",null,"\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e24\u70b9\uff0c\u4e00\u4e2a\u662fSecret\u503c\u95ee\u9898\uff0c\u9700\u8981\u907f\u514d\\n\u6216\u8005\u7a7a\u683c\u5f71\u54cd"),(0,s.kt)("p",null,"\u5efa\u8bae\u8fd9\u6837 ",(0,s.kt)("inlineCode",{parentName:"p"},"echo -n YOUR_ACCESS_KEY | base64"),"\uff0c \u8fd8\u6709\u5982\u679c\u662f\u8981\u521b\u5efa ClusterIssuer\uff0cSecret \u9700\u8981\u521b\u5efa\u5728 cert-manager \u6240\u5728\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u5982\u679c\u662f Issuer\uff0c\u90a3\u5c31\u521b\u5efa\u5728 Issuer \u6240\u5728\u547d\u540d\u7a7a\u95f4\u4e2d\u3002"),(0,s.kt)("p",null,"\u7b2c2\u4e2a\u70b9\u5c31\u662f\u914d\u7f6ealidns\u7684RAM\uff0c\u8fd9\u91cc\u6709\u4e2aRAM\u5751\u3002"),(0,s.kt)("p",null,"RAM\u6743\u9650\u8bbe\u7f6e\u5982\u4e0b:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "Version": "1",\n    "Statement": [\n        {\n            "Action": "*",\n            "Resource": "acs:alidns:*:*:domain/<\u57df\u540d>",\n            "Effect": "Allow"\n        },\n        {\n            "Action": [\n                "alidns:DescribeSiteMonitorIspInfos",\n                "alidns:DescribeSiteMonitorIspCityInfos",\n                "alidns:DescribeSupportLines",\n                "alidns:DescribeDomains",\n                "alidns:DescribeDomainNs",\n                "alidns:DescribeDomainGroups"\n            ],\n            "Resource": "acs:alidns:*:*:*",\n            "Effect": "Allow"\n        }\n    ]\n}\n')),(0,s.kt)("p",null,"\u6b63\u5e38\u60c5\u51b5\u4e0b\u53ea\u9700\u8981\u914d\u7f6e\u7b2c\u4e00\u6761\u89c4\u5219\u5373\u53ef\uff0c\u4f46\u662f\u7531\u4e8ealidns-webhook\u4f1a\u6821\u9a8c\u8fd9\u4e2a\u57df\u540d\u5b58\u4e0d\u5b58\u5728,\u5982\u679c\u4e0d\u914d\u7f6e\u4f1a\u62a5403\u6743\u9650"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-go"},'# https://github.com/pragkent/alidns-webhook/blob/master/alidns/client.go#L26\nfunc (c *Client) getHostedZone(zone string) (string, error) {\n    request := alidns.CreateDescribeDomainsRequest()\n    request.KeyWord = util.UnFqdn(zone)\n    request.SearchMode = "EXACT"\n\n    response, err := c.dnsc.DescribeDomains(request)\n    if err != nil {\n        return "", err\n    }\n\n    zones := response.Domains.Domain\n    if len(zones) == 0 {\n        return "", fmt.Errorf("zone %s does not exist", zone)\n    }\n\n    return zones[0].DomainName, nil\n}\n')),(0,s.kt)("h3",{id:"\u521b\u5efaclusterissuer"},"\u521b\u5efaClusterIssuer"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: cert-manager.io/v1alpha2\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    # Change to your letsencrypt email\n    email: your@domain # \u4f60\u7684\u90ae\u7bb1\n    server: https://acme-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: letsencrypt-prod\n    solvers:\n    - dns01:\n        webhook:\n          groupName: acme.yourcompany.com\n          solverName: alidns\n          config:\n            region: ""\n            accessKeySecretRef:\n              name: alidns-secret\n              key: access-key\n            secretKeySecretRef:\n              name: alidns-secret\n              key: secret-key\n')),(0,s.kt)("h3",{id:"\u521b\u5efa-certificate"},"\u521b\u5efa Certificate"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: cert-manager.io/v1alpha2\nkind: Certificate\nmetadata:\n  name: tls-ops-domain-prod\n  namespace: gaea-op\nspec:\n  secretName: tls-ops-domain-prod # \u8bc1\u4e66\u4fdd\u5b58\u7684 secret \u540d\n  commonName: \n  dnsNames:\n  - "*.bj-internal.ops.domain"\n  - "*.bj-external.ops.domain"\n  issuerRef:\n    name: letsencrypt-prod\n    kind: ClusterIssuer\n')),(0,s.kt)("p",null,"\u901a\u8fc7dns\u9a8c\u8bc1\u53ef\u4ee5\u521b\u5efa\u6cdb\u57df\u540d\u8bc1\u4e66\u3002"),(0,s.kt)("h3",{id:"\u83b7\u53d6\u548c\u4f7f\u7528\u8bc1\u4e66"},"\u83b7\u53d6\u548c\u4f7f\u7528\u8bc1\u4e66"),(0,s.kt)("p",null,"\u521b\u5efa\u597d Certificate \u540e\uff0c\u7a0d\u7b492-3\u5206\u949f \u6211\u4eec\u53ef\u4ee5 \u67e5\u770b\u662f\u5426\u7b7e\u53d1\u6210\u529f:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"kubectl get certificate -n gaea-op\nNAME                READY   SECRET                  AGE\ntls-ops-domain-prod   True   tls-ops-domain-prod   2m\n")),(0,s.kt)("p",null,"\u67e5\u770b\u8bc1\u4e66\u4fe1\u606f"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"kubectl get secrets/tls-ops-domain-prod  -n gaea-op -o json | jq '.data.\"tls.crt\"' | tr '\\\"' ' ' | base64 -D | openssl x509 -in /dev/stdin -text -noout\n\n")),(0,s.kt)("h3",{id:"\u4f7f\u7528\u8bc1\u4e66"},"\u4f7f\u7528\u8bc1\u4e66"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: log\n  namespace: gaea-op\nspec:\n  rules:\n  - host: log01.bj-internal.ops.domain\n    http:\n      paths:\n      - backend:\n          serviceName: log\n          servicePort: http-2379\n        path: /\n  tls:\n  - hosts:\n    - log01.bj-internal.ops.domain\n    secretName: tls-ops-domain-prod\nstatus:\n  loadBalancer:\n    ingress:\n    - ip: 10.10.10.159\n")),(0,s.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,s.kt)("p",null,"\u5230\u8fd9\u91cc\u4e3a\u6b62,  ",(0,s.kt)("b",null,"cert-manager ")," \u57fa\u672c\u64cd\u4f5c\u5df2\u7ecf\u5b8c\u6210\u3002"),(0,s.kt)("p",null,"\u6e90\u7801\u90e8\u5206  ",(0,s.kt)("a",{parentName:"p",href:"https://gitee.com/godu/helminit"},"godu/helminit")))}d.isMDXComponent=!0}}]);