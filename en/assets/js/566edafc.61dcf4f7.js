"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[8141],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return g}});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),l=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=l(e.components);return r.createElement(i.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,i=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),m=l(n),d=a,g=m["".concat(i,".").concat(d)]||m[d]||u[d]||s;return n?r.createElement(g,o(o({ref:t},p),{},{components:n})):r.createElement(g,o({ref:t},p))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,o=new Array(s);o[0]=d;var c={};for(var i in t)hasOwnProperty.call(t,i)&&(c[i]=t[i]);c.originalType=e,c[m]="string"==typeof e?e:a,o[1]=c;for(var l=2;l<s;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},29504:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return i},default:function(){return g},frontMatter:function(){return c},metadata:function(){return l},toc:function(){return m}});var r=n(87462),a=n(63366),s=(n(67294),n(3905)),o=["components"],c={title:"\u57fa\u4e8eDNSPOD\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66",date:new Date("2021-11-22T02:51:42.000Z"),description:"k8s\u4e0a\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1 TLS \u8bc1\u4e66",tags:["cert-manager","kubernetes","qcloud"]},i=void 0,l={permalink:"/en/posts/tke-dnspod-cert-manager-install",source:"@site/blog/posts/tke-dnspod-cert-manager-install.md",title:"\u57fa\u4e8eDNSPOD\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66",description:"k8s\u4e0a\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1 TLS \u8bc1\u4e66",date:"2021-11-22T02:51:42.000Z",formattedDate:"November 22, 2021",tags:[{label:"cert-manager",permalink:"/en/tags/cert-manager"},{label:"kubernetes",permalink:"/en/tags/kubernetes"},{label:"qcloud",permalink:"/en/tags/qcloud"}],readingTime:1.1966666666666668,hasTruncateMarker:!0,authors:[],frontMatter:{title:"\u57fa\u4e8eDNSPOD\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66",date:"2021-11-22T02:51:42.000Z",description:"k8s\u4e0a\u4f7f\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1 TLS \u8bc1\u4e66",tags:["cert-manager","kubernetes","qcloud"]},prevItem:{title:"Tke\u96c6\u7fa4\u57fa\u4e8eCFS\u52a8\u6001\u521b\u5efa\u4e0d\u540c\u5b50\u76ee\u5f55\u7684pvc",permalink:"/en/posts/tke-cfs-nfs-client"},nextItem:{title:"Drone\u914d\u7f6e\u7ba1\u7406\u5458\u8d26\u53f7",permalink:"/en/posts/drone-config-admin"}},p={authorsImageUrls:[]},m=[{value:"\u5e8f",id:"\u5e8f",level:2},{value:"\u5b89\u88c5cert-manager",id:"\u5b89\u88c5cert-manager",level:2},{value:"\u5b89\u88c5dnspod webhook",id:"\u5b89\u88c5dnspod-webhook",level:2},{value:"\u521b\u5efaClusterIssuer",id:"\u521b\u5efaclusterissuer",level:2},{value:"\u521b\u5efa Certificate",id:"\u521b\u5efa-certificate",level:3},{value:"\u90e8\u7f72",id:"\u90e8\u7f72",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}],u={toc:m},d="wrapper";function g(e){var t=e.components,n=(0,a.Z)(e,o);return(0,s.kt)(d,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"\u5e8f"},"\u5e8f"),(0,s.kt)("p",null,"\u6700\u8fd1\u5728\u4f7f\u7528tke\u96c6\u7fa4\u548cdnspod, \u8bb0\u5f55\u4e00\u4e0b\u57fa\u4e8ednspod\u90e8\u7f72cert-manager"),(0,s.kt)("h2",{id:"\u5b89\u88c5cert-manager"},"\u5b89\u88c5cert-manager"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u8fd9\u91cc\u4f7f\u7528bitnami\u63d0\u4f9b\u7684cert-manager")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create namespace cert-manager\nhelm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo update\nhelm upgrade -i cert-manager -n cert-manager --set installCRDs=true --set leaderElection.namespace=cert-manager bitnami/cert-manager\n")),(0,s.kt)("h2",{id:"\u5b89\u88c5dnspod-webhook"},"\u5b89\u88c5dnspod webhook"),(0,s.kt)("p",null,"\u521b\u5efa\u817e\u8baf\u4e91API token"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"helm repo add roc https://charts.imroc.cc\nhelm repo update\nhelm upgrade -i  cert-manager-webhook-dnspod roc/cert-manager-webhook-dnspod \\\n    --namespace cert-manager \\\n    --set clusterIssuer.secretId=<SECRET_ID> \\\n    --set clusterIssuer.secretKey=<SECRET_KEY> \n")),(0,s.kt)("h2",{id:"\u521b\u5efaclusterissuer"},"\u521b\u5efaClusterIssuer"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"\u7531\u4e8e\u4e0a\u9762\u914d\u7f6e\u4e86\u9ed8\u8ba4\u521b\u5efa, \u9ed8\u8ba4ClusterIssuer\u4e3a",(0,s.kt)("inlineCode",{parentName:"p"},"dnspod"))),(0,s.kt)("h3",{id:"\u521b\u5efa-certificate"},"\u521b\u5efa Certificate"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: tls-ops-default-ops-com-prod\n  namespace: default\nspec:\n  secretName: tls-ops-default-ops-com-prod # \u8bc1\u4e66\u4fdd\u5b58\u7684 secret \u540d\n  dnsNames:\n  - "*.default.ops.com"\n  issuerRef:\n    name: dnspod\n    kind: ClusterIssuer\n    group: cert-manager.io\n')),(0,s.kt)("p",null,"\u901a\u8fc7dns\u9a8c\u8bc1\u53ef\u4ee5\u521b\u5efa\u6cdb\u57df\u540d\u8bc1\u4e66\u3002"),(0,s.kt)("h2",{id:"\u90e8\u7f72"},"\u90e8\u7f72"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"\u5728ingress\u91cc\u4f7f\u7528")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8\n  labels:\n    app: cce\n  name: cce\n  namespace: cce-system\nspec:\n  rules:\n  - host: api.cce-system.internal.ysicing.net\n    http:\n      paths:\n      - backend:\n          service:\n            name: cce\n            port:\n              number: 8080\n        path: /\n        pathType: Prefix\n  tls:\n  - hosts:\n    - api.cce-system.internal.ysicing.net\n    secretName: cce-tls\n")),(0,s.kt)("ol",{start:2},(0,s.kt)("li",{parentName:"ol"},"\u5728istio ingressgateway\u4e2d\u4f7f\u7528")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: example-gw\n  namespace: istio-system\nspec:\n  selector:\n    app: istio-ingressgateway\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 80\n      name: HTTP-80\n      protocol: HTTP\n    hosts:\n    - example.com\n    - "*.example.com"\n    tls:\n      httpsRedirect: true # http \u91cd\u5b9a\u5411 https (\u5f3a\u5236 https)\n  - port:\n      number: 443\n      name: HTTPS-443\n      protocol: HTTPS\n    hosts:\n    - example.com\n    - "*.example.com"\n    tls:\n      mode: SIMPLE\n      credentialName: example-crt-secret # \u5f15\u7528\u8bc1\u4e66 secret\n---\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: example-vs\n  namespace: test\nspec:\n  gateways:\n  - istio-system/example-gw # \u8f6c\u53d1\u89c4\u5219\u7ed1\u5b9a\u5230 ingressgateway\uff0c\u5c06\u670d\u52a1\u66b4\u9732\u51fa\u53bb\n  hosts:\n  - \'test.example.com\'\n  http:\n  - route:\n    - destination:\n        host: example\n        port:\n          number: 80\n')),(0,s.kt)("h2",{id:"\u53c2\u8003"},"\u53c2\u8003"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://imroc.cc/k8s/trick/cert-manager-webhook-dnspod/"},"https://imroc.cc/k8s/trick/cert-manager-webhook-dnspod/")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"/posts/cert-manager-install/"},"k8s\u4e0a\u5229\u7528cert-manager\u81ea\u52a8\u7b7e\u53d1TLS\u8bc1\u4e66")))}g.isMDXComponent=!0}}]);